import { query, internalQuery } from "./_generated/server";
import { v } from "convex/values";

export interface HelpSection {
  id: string;
  title: string;
  content: string;
  category: 'basic' | 'staff' | 'qr' | 'attendance' | 'settings' | 'dashboard';
  keywords: string[];
}

// ヘルプセクションのデータ
const helpSections: HelpSection[] = [
  // 基本操作
  {
    id: 'system-overview',
    title: 'システム概要',
    content: `QR勤怠管理システムは、QRコードを使用したタッチレス勤怠管理システムです。
    
**主な機能：**
- QRコードによる出勤・退勤打刻
- スタッフ管理（追加・編集・削除）
- 勤怠データの確認・管理
- 月次レポートとカレンダー表示
- AIアシスタントによるサポート

**システムの特徴：**
- タッチレスで衛生的
- リアルタイム勤怠管理
- 直感的なUI設計
- 多様なレポート機能

**対象ユーザー：**
- 管理者：スタッフ管理、設定、レポート確認
- スタッフ：QRコードによる打刻`,
    category: 'basic',
    keywords: ['システム', '概要', 'QRコード', '勤怠管理', 'タッチレス']
  },
  
  {
    id: 'basic-navigation',
    title: '基本的な使い方',
    content: `システムの基本的な操作方法：

**メニュー構成：**
- **勤怠管理ボード**: 勤怠データの確認とグラフ表示
- **スタッフ一覧**: スタッフの追加・編集・削除
- **QR打刻ページ**: QRコード生成と打刻URL管理
- **月次レポート**: 月別勤怠データの確認
- **月次カレンダー**: カレンダー形式での勤怠表示
- **勤務設定**: 労働時間・休憩時間の設定
- **ヘルプ**: 使い方とFAQ

**操作の流れ：**
1. スタッフを追加する
2. QRコードを生成・配布する
3. QR打刻ページで打刻環境を準備する
4. スタッフがQRコードで打刻する
5. 勤怠データを確認・管理する

**困ったときは：**
右上のAIボタンを押してAIアシスタントにご相談ください。`,
    category: 'basic',
    keywords: ['使い方', 'メニュー', '操作', '基本', 'AI', 'アシスタント']
  },
  
  // スタッフ管理
  {
    id: 'staff-add',
    title: 'スタッフの追加',
    content: `新しいスタッフを追加する手順：

**手順：**
1. 左メニューから「スタッフ一覧」を選択
2. 右上の「スタッフ追加」ボタンをクリック
3. 必要な情報を入力：
   - **名前**: スタッフの氏名（必須）
   - **タグ**: グループ分類（任意）
4. 「追加」ボタンで保存

**タグ機能：**
- 部署やチーム別の分類に使用
- 複数のタグを設定可能
- フィルタリングや検索に活用`,
    category: 'staff',
    keywords: ['スタッフ', '追加', '登録', 'タグ']
  },
  
  {
    id: 'staff-edit',
    title: 'スタッフ情報の編集',
    content: `既存スタッフの情報を編集する方法：

**編集手順：**
1. 左メニューから「スタッフ一覧」を選択
2. 編集したいスタッフの「編集」ボタンをクリック
3. 編集可能な項目を修正：
   - 名前
   - タグ
4. 「保存」ボタンで変更を確定

**編集可能な項目：**
- 名前：スタッフの氏名
- タグ：グループ分類や部署分け`,
    category: 'staff',
    keywords: ['スタッフ', '編集', '更新', 'タグ']
  },

  {
    id: 'staff-status',
    title: 'スタッフの無効化・有効化管理',
    content: `スタッフの有効/無効状態を管理する方法：

**スタッフを無効化する手順：**
1. 「スタッフ一覧」で対象スタッフにチェックを入れる
2. 「一括無効化」ボタンを押す
3. 確認ダイアログで実行

**無効化されたスタッフを有効化する手順：**
1. 「スタッフ一覧」ページで「無効スタッフ表示」ボタンを押す
2. 有効にしたいスタッフにチェックを入れる
3. 「一括有効化」ボタンを押す
4. 確認ダイアログで実行

**有効/無効の違い：**
- **有効**: 通常の勤怠管理対象、QRコード有効
- **無効**: 勤怠管理対象外、QRコード無効

**注意点：**
- 無効化しても過去の勤怠データは保持されます
- 一括操作で複数スタッフの状態を同時に変更可能
- 無効化されたスタッフは通常のスタッフ一覧には表示されません`,
    category: 'staff',
    keywords: ['スタッフ', '無効化', '有効化', '状態', '管理', '一括操作']
  },
  
  // QRコード関連
  {
    id: 'qr-generation',
    title: 'QRコードの生成',
    content: `スタッフのQRコードを生成する方法：

**個別QRコード生成：**
1. 左メニューから「スタッフ一覧」を選択
2. 各スタッフの行にある「QRコード生成」ボタンをクリック
3. そのスタッフのQRコードが載ったPDFが自動的にダウンロードされます

**一括QRコード生成：**
1. 「スタッフ一覧」画面で対象のスタッフをチェックボックスで選択
2. 「一括QRコード生成」ボタンをクリック
3. 選択した全スタッフのQRコードが含まれたPDFがダウンロードされます

**QRコードの特徴：**
- 各スタッフ固有のQRコードが生成されます
- 一度生成されたQRコードは永続的に有効です
- 期限切れはありません`,
    category: 'basic',
    keywords: ['QRコード', '生成', 'PDF', 'ダウンロード', '一括']
  },
  
  // 勤怠管理（4つのアコーディオンに分割）
  {
    id: 'attendance-clock',
    title: '打刻の操作',
    content: `QRコードを使用した打刻手順：

**スタッフ側の操作：**
1. 左メニューから「QR打刻ページ」を選択
2. 実際のカメラ読み取り用のページに遷移
3. 打刻の種類を選択（出勤/退勤）
4. 打刻用デバイスのカメラ画面を開く
5. 自分のQRコードをカメラにかざす
6. 打刻完了

**打刻の種類：**
- **出勤**: カメラ起動前に「出勤」を選択
- **退勤**: カメラ起動前に「退勤」を選択
- 出勤/退勤は自動判定されず、事前に選択が必要

**操作のコツ：**
- QRコードは画面から15-20cm程度の距離でかざす
- 汚れや破損したQRコードは読み取りエラーの原因となります
- 打刻時刻は自動的に記録されます`,
    category: 'attendance',
    keywords: ['打刻', '出勤', '退勤', 'QRコード', 'タッチレス']
  },
  
  {
    id: 'attendance-dashboard',
    title: '勤怠管理ボード',
    content: `勤怠管理ボードでは、その日の勤怠状況をリアルタイムで確認できます：

**表示される情報：**
- **現在の出勤者**: 現在オフィスにいるスタッフの人数
- **本日の出勤完了者**: 既に退勤したスタッフの人数  
- **勤務エラー数**: 打刻漏れや異常な勤務時間などのエラー件数
- **出勤・退勤時刻**: 今日出勤しているスタッフの出勤時刻と退勤時刻

**主な用途：**
- その日の出勤状況の把握
- 勤務エラーの早期発見
- スタッフの在席状況確認
- 日次の勤怠管理

**注意点：**
- 週次や月次の統計機能はありません
- あくまでその日限りの状況確認用のボードです`,
    category: 'dashboard',
    keywords: ['勤怠管理', 'ボード', '出勤者', 'エラー', '日次']
  },
  
  {
    id: 'attendance-staff-detail',
    title: '個別スタッフの勤務履歴確認',
    content: `個別スタッフの詳細な勤務状況を確認する機能：

**確認できる情報：**
- 個別スタッフの月次勤怠履歴
- 日別の打刻記録（出勤・退勤時刻）
- 勤務時間の詳細分析
- 打刻の修正履歴
- 勤務パターンの把握

**機能：**
- **CSVエクスポート**: 勤怠データをCSV形式で出力可能
- 打刻データの修正
- 手動での勤怠入力
- メモ・備考の追加

**操作方法：**
1. 左メニューから「スタッフ一覧」を選択
2. 対象スタッフを探す
3. そのスタッフ名の横にある「詳細」ボタンをクリック
4. 詳細画面で勤務履歴を確認
5. 期間を指定してデータ表示期間を変更
6. 必要に応じてCSVでエクスポート

**活用場面：**
- 個別スタッフの勤務状況分析
- 給与計算の詳細確認
- 勤務パターンの把握`,
    category: 'attendance',
    keywords: ['スタッフ詳細', '勤怠履歴', '打刻修正', '手動入力', 'CSV', '個別分析']
  },
  
  {
    id: 'attendance-monthly-report',
    title: '月次レポート',
    content: `月次レポートの確認方法：

**確認できる情報：**
- **総勤務時間**: 対象期間での合計勤務時間
- **総勤務日数**: 対象期間での出勤日数
- **総残業時間**: 対象期間での残業時間合計
- **スタッフ数**: 対象となるスタッフ数
- **各スタッフの勤務実績**: 個別の勤務時間と日数

**機能：**
- **CSVエクスポート**: データをCSV形式で出力可能
- **期間選択**: 前月など任意の期間での確認
- **タグフィルター**: 特定のグループ（部署等）のみの集計

**操作方法：**
1. 左メニューから「月次レポート」を選択
2. 期間とフィルター条件を設定
3. レポートデータを確認
4. 必要に応じてCSVでエクスポート

**注意：**
- **この機能はプロ版（有料版）でのみ利用可能です**

**活用場面：**
- 給与計算の基礎データ
- グループ別の勤務状況分析
- 残業時間の管理と分析`,
    category: 'attendance',
    keywords: ['月次レポート', '集計', '労働時間', '残業', 'エクスポート', 'CSV', 'プロ版']
  },
  
  {
    id: 'attendance-monthly-calendar',
    title: '月次カレンダー',
    content: `月次カレンダーの使い方：

**表示機能：**
- **年月選択**: 確認したい年と月を指定
- **タグフィルター**: 特定のグループ（部署等）で絞り込み
- **カレンダー形式表示**: 視覚的な勤務状況の確認

**確認できる情報：**
- 各スタッフの出勤日
- 日別の出勤・退勤時刻
- 出勤時の労働時間
- 休日・欠勤の表示
- 勤務パターンの視覚化

**操作方法：**
1. 左メニューから「月次カレンダー」を選択
2. 年月を選択
3. タグフィルターを設定（必要に応じて）
4. カレンダーでの勤怠状況確認
5. 各日をクリックして詳細表示

**主な活用場面：**
- **シフト表との整合性確認**: 予定と実績の照合
- スタッフ個人の勤務パターン分析
- 月間の勤務状況の視覚的把握
- スケジュール管理と調整`,
    category: 'attendance',
    keywords: ['月次カレンダー', 'カレンダー', 'スケジュール', '勤務パターン', 'シフト表', 'タグフィルター']
  },
  
  // 設定
  {
    id: 'work-settings',
    title: '勤務設定',
    content: `勤務設定の管理方法：

**勤務設定の作成：**
1. 左メニューから「勤務設定」を選択
2. 「新しい設定を追加」ボタンを押す
3. 以下の項目を設定：
   - **設定名**: 分かりやすい名前
   - **労働時間**: 1日の標準労働時間（時間）
   - **休憩時間**: 1日の休憩時間（時間）
4. 「保存」で設定完了

**勤務設定の効果：**
- 設定をベースにスタッフに勤務パターンを自動で割り当て
- 残業時間の計算を自動的に行う
- 労働基準に合わせた勤怠管理

**使用例：**
- フルタイム: 労働8時間、休憩1時間
- パートタイム: 労働4時間、休憩0.5時間
- シフト制: 労働6時間、休憩1時間

**デフォルト設定：**
最初に作成した設定が新規スタッフのデフォルトになります。`,
    category: 'settings',
    keywords: ['勤務設定', '労働時間', '休憩時間', '残業計算', 'デフォルト']
  },
  
  // トラブルシューティング
  {
    id: 'troubleshoot-qr',
    title: 'QRコード読み取りエラー',
    content: `QRコードが読み取れない場合の対処法：

**よくある原因と対策：**

**1. QRコードの汚れ・破損**
- QRコードを清拭する
- 新しいQRコードを印刷する
- ラミネート加工で保護する

**2. 距離・角度の問題**
- カメラから15-20cm程度の距離を保つ
- QRコードを平行に保つ
- 照明を確認する（逆光を避ける）

**3. デバイスの問題**
- カメラレンズを清拭する
- ブラウザを再読み込みする
- デバイスを再起動する

**緊急時の対応：**
管理者が手動で打刻データを入力することも可能です。`,
    category: 'basic',
    keywords: ['QRコード', 'エラー', '読み取り', 'トラブル', '対処法']
  },

  {
    id: 'troubleshoot-general',
    title: '一般的なトラブル対応',
    content: `システム利用時のトラブル対応：

**ページが表示されない場合：**
- ブラウザを再読み込み（Ctrl+F5）
- キャッシュをクリア
- 異なるブラウザで確認

**データが表示されない場合：**
- インターネット接続を確認
- しばらく待ってから再度確認
- ページを再読み込み

**ログインできない場合：**
- URL・認証情報を確認
- パスワードリセットを実行

**その他のサポート：**
右上のAIボタンを押してAIアシスタントにご相談ください。`,
    category: 'basic',
    keywords: ['トラブル', 'エラー', 'ログイン', 'サポート', 'AI']
  },


];

// 全ヘルプセクションを取得
export const getHelpSections = query({
  args: {},
  returns: v.array(v.object({
    id: v.string(),
    title: v.string(),
    content: v.string(),
    category: v.string(),
    keywords: v.array(v.string())
  })),
  handler: async (ctx) => {
    return helpSections;
  }
});

// カテゴリ別ヘルプセクションを取得
export const getHelpByCategory = query({
  args: { category: v.string() },
  returns: v.array(v.object({
    id: v.string(),
    title: v.string(),
    content: v.string(),
    category: v.string(),
    keywords: v.array(v.string())
  })),
  handler: async (ctx, args) => {
    return helpSections.filter(section => section.category === args.category);
  }
});

// キーワード検索
export const searchHelp = query({
  args: { query: v.string() },
  returns: v.array(v.object({
    id: v.string(),
    title: v.string(),
    content: v.string(),
    category: v.string(),
    keywords: v.array(v.string())
  })),
  handler: async (ctx, args) => {
    const searchTerms = args.query.toLowerCase().split(' ');
    
    return helpSections.filter(section => {
      const searchText = `${section.title} ${section.content} ${section.keywords.join(' ')}`.toLowerCase();
      return searchTerms.every(term => searchText.includes(term));
    });
  }
});

// AIアシスタント用のヘルプ情報取得
export const getHelpForAI = internalQuery({
  args: {},
  returns: v.string(),
  handler: async (ctx) => {
    return helpSections.map(section => 
      `## ${section.title}\n${section.content}\n\nキーワード: ${section.keywords.join(', ')}`
    ).join('\n\n---\n\n');
  }
}); 